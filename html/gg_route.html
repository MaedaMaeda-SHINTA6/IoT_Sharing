<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>経路案内</title>

    <!-- Bootstrap core CSS -->
    <link href="./css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="./css/custom/home.css" rel="stylesheet">
    <link href="./css/custom/gmaps.css" rel="stylesheet">
</head>

<body>

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <a class="navbar-brand" href="#">農作物シェアリング</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault"
            aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="#">農業シェアリングサービスとは
                        <span class="sr-only">(current)</span>
                    </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">メニュー</a>
                    <div class="dropdown-menu" aria-labelledby="dropdown01">
                        <a class="dropdown-item" href="#">農家の方へ</a>
                        <a class="dropdown-item" href="#">配達ドライバーの方へ</a>
                        <a class="dropdown-item" href="./Webcamera">現地の様子</a>
                    </div>
                </li>
            </ul>
            <form class="form-inline my-2 my-lg-0" action="/login" method="post">
                <!--<input class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">-->
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">ログイン</button>
            </form>
        </div>
    </nav>

    <main role="main" class="container">

        <!-- タイトル -->
        <div class="text-center mt-5">
            <h3>ルート探索</h3>
        </div>
        <!-- Google Maps出力 -->
        <div id="gmaps_view"></div>

    </main>
    </br>

    <!-- /.container -->

    <footer class="fixed-bottom">
        <p>
            <a href="#" class="btn-circle">^</a>
        </p>
    </footer>
    <div class="Sharing_footer">
        <p>Copyright 2018 FSIT FLM</p>
    </div>
    <!-- /.footer -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="./assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
    <script src="./assets/js/vendor/popper.min.js"></script>
    <script src="./js/bootstrap.min.js"></script>

    <!-- Google Maps Custom JS-->
    <script>
        function initMap() {
            // たくさんの地点...
            var points = [
                new google.maps.LatLng(33.55882,133.526836),
                new google.maps.LatLng(33.5587218, 133.5290542),
                new google.maps.LatLng(33.5570871, 133.5300218),
                new google.maps.LatLng(33.5612665, 133.5330113),
                new google.maps.LatLng(33.5614465, 133.5350113)
            ];

            // マップの生成
            var map = new google.maps.Map(document.getElementById("gmaps_view"), {
                center: new google.maps.LatLng(33.55882,133.526836), // マップの中心
                zoom: 16 // ズームレベル
            });

            // 地点を分割してルート検索を行います。

            var d = new google.maps.DirectionsService(); // ルート検索オブジェクト
            var origin = null, waypoints = [], dest = null; // 出発地、経由地、目的地
            var resultMap = {}; // 分割してルート検索した結果データ
            var requestIndex = 0; // 検索番号
            var done = 0; // ルート検索が完了した数
            for (var i = 0, len = points.length; i < len; i++) {
                // 最初の場合、originに値をセット
                if (origin == null) {
                    origin = points[i];
                }
                // 経由地が8つたまったか最後の地点の場合、ルート検索
                else if (waypoints.length == 8 || i == len - 1) {
                    dest = points[i];

                    (function (index) {
                        // ルート検索の条件
                        var request = {
                            origin: origin, // 出発地
                            destination: dest, // 目的地
                            waypoints: waypoints, // 経由地
                            travelMode: google.maps.DirectionsTravelMode.WALKING, // 交通手段(歩行。DRIVINGの場合は車)
                        };
                        console.log(request);
                        // ルート検索
                        d.route(request, function (result, status) {
                            // OKの場合ルートデータ保持
                            if (status == google.maps.DirectionsStatus.OK) {
                                resultMap[index] = result; // 並行でリクエストするので配列だとリクエスト順とずれる場合があります
                                done++;
                            }
                            else {
                                console.log(status); // デバッグ
                            }
                        });
                    })(requestIndex);

                    requestIndex++;
                    origin = points[i]; // 今回の目的地を次回の出発地にします。
                    waypoints = [];
                }
                // 上記以外、waypointsに地点を追加
                else {
                    waypoints.push({ location: points[i], stopover: true });
                }
            }

            // マーカーを表示する場合の準備
            var infoWindow = new google.maps.InfoWindow();
            var mark = function (position, content) {
                var marker = new google.maps.Marker({
                    map: map, // 描画先の地図
                    position: position // 座標
                });
                // クリック時吹き出しを表示
                marker.addListener("click", function () {
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
            };

            var sid = setInterval(function () {
                // 分割したすべての検索が完了するまで待ちます。
                if (requestIndex > done) return;
                clearInterval(sid);

                // すべての結果のルート座標を順番に取得して平坦な配列にします。
                var path = [];
                var result;
                for (var i = 0, len = requestIndex; i < len; i++) {
                    result = resultMap[i]; // 検索結果
                    var legs = result.routes[0].legs; // Array<DirectionsLeg>
                    for (var li = 0, llen = legs.length; li < llen; li++) {
                        var leg = legs[li]; // DirectionLeg
                        var steps = leg.steps; // Array<DirectionsStep>
                        // DirectionsStepが持っているpathを取得して平坦(2次元配列→1次元配列)にします。
                        var _path = steps.map(function (step) { return step.path })
                            .reduce(function (all, paths) { return all.concat(paths) });
                        path = path.concat(_path);

                        // マーカーが必要ならマーカーを表示します。
                        mark(leg.start_location, leg.start_address);
                    }
                }
                // マーカーが必要ならマーカーを表示します。(最終)
                var endLeg = result.routes[0].legs[result.routes[0].legs.length - 1];
                mark(endLeg.end_location, endLeg.end_address);

                // パスを描画します。
                var line = new google.maps.Polyline({
                    map: map, // 描画先の地図
                    strokeColor: "#FF4500", // 線の色
                    strokeOpacity: 0.8, // 線の不透明度
                    strokeWeight: 7, // 先の太さ
                    path: path // 描画するパスデータ
                });
            }, 1000);
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6vQRmMUhpH9ZD5GaCdoGMCHOTcgCZS4I&callback=initMap"></script>

</body>

</html>